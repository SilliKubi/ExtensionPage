const icon = "data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSI4OC4xMDA5NiIgaGVpZ2h0PSI4OC4xMDA5NiIgdmlld0JveD0iMCwwLDg4LjEwMDk2LDg4LjEwMDk2Ij48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTk1Ljk0OTUyLC0xMzUuOTQ5NTIpIj48ZyBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiPjxwYXRoIGQ9Ik0xOTUuOTQ5NTIsMTgwYzAsLTI0LjMyODQxIDE5LjcyMjA3LC00NC4wNTA0OCA0NC4wNTA0OCwtNDQuMDUwNDhjMjQuMzI4NDEsMCA0NC4wNTA0OCwxOS43MjIwNyA0NC4wNTA0OCw0NC4wNTA0OGMwLDI0LjMyODQxIC0xOS43MjIwNyw0NC4wNTA0OCAtNDQuMDUwNDgsNDQuMDUwNDhjLTI0LjMyODQxLDAgLTQ0LjA1MDQ4LC0xOS43MjIwNyAtNDQuMDUwNDgsLTQ0LjA1MDQ4eiIgZmlsbD0iI2UwOGNmZiIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjAiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiLz48ZWxsaXBzZSBjeD0iNDQyLjI3ODIyIiBjeT0iNDE1LjYzMDUxIiB0cmFuc2Zvcm09InNjYWxlKDAuNSwwLjUpIiByeD0iMCIgcnk9IjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSI3LjUiIHN0cm9rZS1saW5lam9pbj0ibWl0ZXIiLz48ZyBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iNy41IiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjM1LjIxNDExLDE5Ni4wNTMyNGMtMS4yMzE5MSwxLjEyNDU4IC0yLjg5MjI0LDEuNzc5MzYgLTQuNjg4NjMsMS42OTc2NWMtMS43OTMsLTAuMDgxNjggLTMuMzg2ODQsLTAuODg0NjcgLTQuNTE0NTEsLTIuMTE2NTJjLTEuMTI0NTgsLTEuMjMxOTEgLTEuNzc5MzYsLTIuODkyMjQgLTEuNjk3NzUsLTQuNjg4MzNjMC4wODE3MSwtMS43OTY0IDAuODg0OCwtMy4zOTA1NCAyLjExNjYxLC00LjUxNDgxYzEuMjM0OSwtMS4xMjQzMyAyLjg5NTIzLC0xLjc3OTExIDQuNjg4MzMsLTEuNjk3NzVjMS43OTYzLDAuMDgyMDIgMy4zOTA0NSwwLjg4NTExIDQuNTE0OCwyLjExNjYxYzEuMTI0MjcsMS4yMzE4MiAxLjc3OTM2LDIuODkyMjQgMS42OTczNCw0LjY4ODU0Yy0wLjA4MTcxLDEuNzk2NCAtMC44ODQ3LDMuMzkwMjQgLTIuMTE2MjEsNC41MTQ1OXoiLz48cGF0aCBkPSJNMjQ5LjA3ODc2LDE1NC41ODAyNWwtMTIuMjE3MTQsMzguMDI3MDkiLz48cGF0aCBkPSJNMjUyLjY1Mzk5LDE2Ny45NTc3MWMtMS4yNjQ5NywtMi42NjExNyAtMy4wMjQ3OCwtNS4wNTU3MyAtNS4xODU4OCwtNy4wNTU5N2wxLjkyMTkyLC02LjIyNTM5YzEuODE4ODgsMi4yMjUzIDMuMzU1MTgsNC42NzAyIDQuNTcyNTQsNy4yNzU3NWMyLjgwMTU0LDUuNTgwMDUgMi4xNjQ2MSwxMi4yNzAzNCAtMS42MzUyOSwxNy4yMjM4NWMxLjE1NjQxLC0zLjYzNTM1IDEuMjY4NTYsLTcuNTIxNTEgMC4zMjY3MSwtMTEuMjE4MjR6Ii8+PC9nPjxwYXRoIGQ9Ik0yMDUuNDI2NzYsMTgwYzAsLTE5LjA5NDI4IDE1LjQ3ODk3LC0zNC41NzMyNCAzNC41NzMyNCwtMzQuNTczMjRjMTkuMDk0MjgsMCAzNC41NzMyNCwxNS40Nzg5NyAzNC41NzMyNCwzNC41NzMyNGMwLDE5LjA5NDI4IC0xNS40Nzg5NiwzNC41NzMyNCAtMzQuNTczMjQsMzQuNTczMjRjLTE5LjA5NDI4LDAgLTM0LjU3MzI0LC0xNS40Nzg5NiAtMzQuNTczMjQsLTM0LjU3MzI0eiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjcuNSIgc3Ryb2tlLWxpbmVqb2luPSJtaXRlciIvPjwvZz48L2c+PC9zdmc+PCEtLXJvdGF0aW9uQ2VudGVyOjQ0LjA1MDQ4MDAwMDAwMDAyOjQ0LjA1MDQ3OTk5OTk5OTk5LS0+"

class TEMPLATE {
  constructor() {
    this.lastBeatTime = 0;
    this.startTime = Date.now(); // new: store start time
    this.pulseWindow = 100;
  }

  getInfo() {
    return {
      id: 'RH',
      name: 'Rhythm Helper V1',
      color1: '#df8aff',
      color2: '#df8aff',
      color3: '#df8aff',
      menuIconURI: icon,

      blocks: [
        {
          blockType: Scratch.BlockType.LABEL,
          text: 'General Blocks',
        },
        {
          opcode: 'resetBeat',
          blockType: Scratch.BlockType.COMMAND,
          text: 'reset timing with offset [offset] seconds ago',
          arguments: {
            offset: { type: Scratch.ArgumentType.NUMBER, defaultValue: 0 }
          }
        },
        {
          opcode: 'beatPulse',
          blockType: Scratch.BlockType.BOOLEAN,
          text: 'register beat at [bpm] BPM every [beats] beats',
          arguments: {
            bpm: { type: Scratch.ArgumentType.NUMBER, defaultValue: 120 },
            beats: { type: Scratch.ArgumentType.NUMBER, defaultValue: 1 }
          }
        },
        {
          blockType: Scratch.BlockType.LABEL,
          text: 'Conversion Blocks',
        },
        {
          opcode: 'bpmtracker',
          blockType: Scratch.BlockType.REPORTER,
          text: 'convert [bpm] to seconds',
          arguments: { bpm: { type: Scratch.ArgumentType.NUMBER, defaultValue: "" } }
        },
        {
          opcode: 'bpmtracker2',
          blockType: Scratch.BlockType.REPORTER,
          text: 'convert [seconds] seconds to BPM',
          arguments: { seconds: { type: Scratch.ArgumentType.NUMBER, defaultValue: "0.5" } }
        },
        {
          blockType: Scratch.BlockType.LABEL,
          text: 'Slider Rhythm Blocks',
        },
        {
          opcode: 'getBeatPosition',
          hideFromPalette: false,
          blockType: Scratch.BlockType.REPORTER,
          text: 'beat position at [bpm] BPM',
          arguments: {
            bpm: { type: Scratch.ArgumentType.NUMBER, defaultValue: 120 }
          }
        }
      ]
    };
  }

  bpmtracker(args) {
    return 60 / args.bpm;
  }

  bpmtracker2(args) {
    return 60 / args.seconds;
  }

  beatPulse(args) {
    const bpm = Number(args.bpm);
    const beats = Number(args.beats);
    const now = Date.now();
    const interval = (60 / bpm) * beats * 1000;
  
    if (now - this.lastBeatTime >= interval) {
      const beatsPassed = Math.floor((now - this.lastBeatTime) / interval);
      this.lastBeatTime += beatsPassed * interval;
      
      return true;
    }
  

    return false;
  }
  
  

  resetBeat(args) {
    const offset = Number(args.offset);
    const now = Date.now();
    this.lastBeatTime = now - (offset * 1000);
    this.startTime = now - (offset * 1000); 
  }

  getBeatPosition(args) {
    const bpm = Number(args.bpm);
    const now = Date.now();
    const elapsedSeconds = (now - this.startTime) / 1000;
    const beats = (bpm / 60) * elapsedSeconds;
    return beats;
  }
}


Scratch.extensions.register(new TEMPLATE());
